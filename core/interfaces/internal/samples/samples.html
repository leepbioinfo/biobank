{% extends "internal/common/base.html" %}
{% load static %}

{% block title %}Samples · CEPIDB3 Biobank{% endblock %}
{% block page_title %}Samples{% endblock %}
{% block page_subtitle %}Manage biological specimens and scientific data{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'internal/samples/samples.css' %}">
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
    /* Estilos Específicos da Página de Amostras */
    .timeline-item { border-left: 2px solid #e9ecef; padding-left: 15px; position: relative; padding-bottom: 10px; }
    .timeline-item::before { content: ""; position: absolute; left: -6px; top: 0; width: 10px; height: 10px; background: #0d6efd; border-radius: 50%; }
    .preview-img { max-width: 100%; height: auto; border-radius: 4px; }
    .print-alert { background-color: #f8f9fa; border-left: 4px solid #0d6efd; }
    .section-label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #6c757d; margin-bottom: 0.5rem; display: block; }

    /* Botões Mini */
    .btn-manage-mini { font-size: 0.7rem; padding: 2px 8px; background: white; border: 1px solid #dee2e6; color: #333; text-decoration: none; }
    .btn-manage-mini:hover { background: #f8f9fa; color: #000; }

    /* Área dos Chips (Tags/Keywords) */
    .chip-box { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px; min-height: 50px; }

    /* Estilo para o Editor do Caderno de Laboratório */
    #eln-editor { height: 250px; background: white; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; }
    .ql-toolbar { border-top-left-radius: 8px; border-top-right-radius: 8px; background: #f8f9fa; }

    /* Uploads */
    .border-dashed { border-style: dashed !important; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">

    {# --- Bloco de Mensagens / Alerta de Impressão --- #}
    {% if messages %}
        {% for message in messages %}
            {% if "sample_created_id" in message.extra_tags %}
                <div class="alert print-alert d-flex justify-content-between align-items-center shadow-sm mb-4" role="alert">
                    <div>
                        <i class="bi bi-printer-fill text-primary me-2"></i>
                        <strong>Amostra Registrada!</strong> Deseja imprimir a etiqueta para o tubo agora?
                    </div>
                    <a href="{% url 'print_sample_label' message.message %}" target="_blank" class="btn btn-primary btn-sm">
                        <i class="bi bi-qr-code-scan me-1"></i> Imprimir Etiqueta
                    </a>
                </div>
            {% endif %}
        {% endfor %}
    {% endif %}

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="h4 mb-0"><i class="bi bi-flask me-2"></i>Specimen Inventory</h3>
        </div>
    </div>

    {% if user.is_authenticated %}
    <section class="card shadow-sm mb-5 border-0">
        <div class="card-header bg-white py-3">
            <h5 class="card-title mb-0 text-primary"><i class="bi bi-plus-circle me-2"></i>Register New Sample</h5>
        </div>
        <div class="card-body">
            <form method="post" enctype="multipart/form-data" class="sample-form" id="mainSampleForm">
                {% csrf_token %}
                <input type="hidden" name="action" value="add_sample">

                {# Input oculto para receber o HTML do Quill #}
                <input type="hidden" name="scientific_notes" id="scientific_notes_input">

                <div class="row g-3">
                    {# --- Coluna 1: Identificação Básica --- #}
                    <div class="col-md-4">
                        <label class="section-label">Sample ID / Barcode</label>
                        <div class="input-group">
                            <input name="sample_id" class="form-control" placeholder="Ex: B3-2024-001" required>
                            <span class="input-group-text bg-light"><i class="bi bi-qr-code"></i></span>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <label class="section-label">Sample Type</label>
                        <input name="sample_type" class="form-control" placeholder="Ex: Bacterial Isolate, DNA">
                    </div>

                    <div class="col-md-4">
                        <label class="section-label">Organism / Strain</label>
                        <input name="organism_name" class="form-control" placeholder="Ex: E. coli">
                    </div>

                    {# --- Coluna 2: Localização e Status --- #}
                    <div class="col-md-6">
                        <label class="section-label">Collection (Optional)</label>
                        <select name="collection" class="form-select">
                            <option value="">— Independent Sample —</option>
                            {% for col in collections %}
                                <option value="{{ col.id }}">{{ col.name }} ({{ col.biobank.name }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="section-label">Storage Location</label>
                        <input name="storage_location" class="form-control" placeholder="Ex: Freezer -80°C, Rack B">
                    </div>

                    <div class="col-md-6">
                        <label class="section-label">Visibility</label>
                        <select name="visibility" class="form-select">
                            <option value="private">Private</option>
                            <option value="group">Group</option>
                            <option value="public">Public</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="section-label">Initial Status</label>
                        <select name="status" class="form-select">
                            <option value="pending">Aguardando Recebimento</option>
                            <option value="qc" selected>Em Controle de Qualidade</option>
                            <option value="available">Disponível</option>
                        </select>
                    </div>

                    {# --- Coluna 3: Tags e Keywords (Unified) --- #}
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <label class="section-label mb-0">Tags</label>
                            <a href="/?page=tags" target="_blank" class="btn btn-manage-mini rounded shadow-sm">
                                <i class="bi bi-tags me-1"></i> Manage Tags
                            </a>
                        </div>
                        <div id="tagChipContainer" class="chip-box mb-2">
                            {% for tag in all_tags %}
                                <span class="badge rounded-pill border text-dark bg-white selectable-tag m-1 p-2"
                                      data-tag-id="{{ tag.id }}" style="cursor:pointer;">{{ tag.name }}</span>
                            {% endfor %}
                        </div>
                        <div id="tagHiddenInputs" style="display:none;"></div>
                        <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addTagModal">
                            <i class="bi bi-plus-circle me-1"></i> New Tag
                        </button>
                    </div>

                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <label class="section-label mb-0">Keywords</label>
                            <a href="/?page=keywords" target="_blank" class="btn btn-manage-mini rounded shadow-sm">
                                <i class="bi bi-key me-1"></i> Manage Keywords
                            </a>
                        </div>
                        <div id="keywordChipContainer" class="chip-box mb-2"></div>
                        <div id="keywordHiddenInputs" style="display:none;"></div>
                        <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addKeywordModal">
                            <i class="bi bi-key me-1"></i> Add Keywords
                        </button>
                    </div>

                    {# --- Coluna 4: ELN e Arquivos --- #}
                    <div class="col-12 mt-4">
                        <label class="section-label"><i class="bi bi-journal-text me-1"></i>Scientific Notebook / ELN</label>
                        <div id="eln-editor"></div>
                        <small class="text-muted">Descreva protocolos, medições e observações experimentais aqui.</small>
                    </div>

                    <div class="col-12 mt-3">
                        <label class="section-label">Attachments</label>
                        <div id="fileContainer" class="mb-2"></div>
                        <button type="button" id="addFileBtn" class="btn btn-sm btn-outline-info"><i class="bi bi-paperclip"></i> Add File</button>
                    </div>
                </div>

                <div class="text-end mt-4 border-top pt-3">
                    <button type="submit" class="btn btn-primary px-5 shadow-sm">Save Specimen</button>
                </div>
            </form>
        </div>
    </section>
    {% endif %}

    {# --- Tabela de Listagem de Amostras --- #}
    <section class="mt-5">
        <div class="table-responsive bg-white rounded shadow-sm">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr class="small text-uppercase">
                        <th>Sample ID</th>
                        <th>Info / Status</th>
                        <th>Hierarchy / Location</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in samples %}
                    <tr>
                        <td>
                            <div class="fw-bold text-primary">{{ s.sample_id }}</div>
                            <small class="text-muted" style="font-size: 0.6rem;">{{ s.uuid }}</small>
                        </td>
                        <td><div class="small fw-bold">{{ s.organism_name|default:"—" }}</div></td>
                        <td>
                            <div class="small"><i class="bi bi-diagram-3 me-1"></i>{{ s.collection.name|default:"Avulsa" }}</div>
                        </td>
                        <td class="text-end">
                            <div class="btn-group">
                                <a href="{% url 'print_sample_label' s.id %}" target="_blank" class="btn btn-sm btn-outline-dark"><i class="bi bi-printer"></i></a>
                                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#historyModal{{ s.id }}"><i class="bi bi-clock-history"></i></button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center py-4 text-muted">No samples found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

    {# --- Modais (Tags e Keywords) --- #}
    {% include "internal/tags/add_tag.html" %}
    {% include "internal/keywords/add_keyword.html" %}

</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
    var quill = new Quill('#eln-editor', {
        theme: 'snow',
        placeholder: 'Protocolos e observações experimentais...',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, false] }],
                ['bold', 'italic', 'underline'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['link', 'blockquote'],
                ['clean']
            ]
        }
    });
</script>

<script src="{% static 'internal/samples/samples.js' %}"></script>
{% endblock %}
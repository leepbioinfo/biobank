{% extends "internal/common/base.html" %}
{% load static %}

{% block title %}Biobanks · Biobank LIMS{% endblock %}
{% block page_title %}Biobanks{% endblock %}
{% block page_subtitle %}Infrastructure and Institution Management{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'internal/biobanks/biobank.css' %}">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
    .section-label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #6c757d; margin-bottom: 0.5rem; display: block; }
    .chip-box { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px; min-height: 50px; }
    #map { cursor: crosshair; z-index: 1; height: 280px; border-radius: 12px; border: 1px solid #ddd; }

    /* Estilo do botão mini que você já tinha */
    .btn-manage-mini { font-size: 0.7rem; padding: 2px 8px; background: white; border: 1px solid #dee2e6; color: #333; text-decoration: none; }
    .btn-manage-mini:hover { background: #f8f9fa; color: #000; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">

{% if user.is_authenticated %}
<section class="card shadow-sm border-0 mb-5">
    <div class="card-header bg-white py-3">
        <h5 class="card-title mb-0 text-primary"><i class="bi bi-building-add me-2"></i>Register New Biobank</h5>
    </div>
    <div class="card-body">

        <form method="POST" action="{% url 'home' %}?page=biobanks" id="biobankForm">
            {% csrf_token %}
            <input type="hidden" name="action" value="add_biobank">

            <div class="row g-4">
                <div class="col-lg-7">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="section-label">Official Name</label>
                            {{ biobank_form.name }}
                        </div>
                        <div class="col-md-4">
                            <label class="section-label">Default Visibility</label>
                            {{ biobank_form.visibility }}
                        </div>
                        <div class="col-12">
                            <label class="section-label">Institution (Auto-fills from map)</label>
                            {{ biobank_form.institution }}
                        </div>
                        <div class="col-12">
                            <label class="section-label">Address</label>
                            {{ biobank_form.location_label }}
                            {{ biobank_form.latitude }}
                            {{ biobank_form.longitude }}
                        </div>
                        <div class="col-12">
                            <label class="section-label">Scientific Notes</label>
                            {{ biobank_form.description }}
                        </div>
                    </div>
                </div>

                <div class="col-lg-5">
                    <label class="section-label">Location</label>
                    <div id="map" class="shadow-sm mb-3"></div>

                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <label class="section-label mb-0">Tags</label>
                            <a href="/?page=tags" class="btn btn-manage-mini rounded shadow-sm">
                                <i class="bi bi-tags me-1"></i> Manage Tags
                            </a>
                        </div>
                        <div id="tagChipContainer" class="chip-box mb-2">
                            {% for tag in all_tags %}
                                <span class="badge rounded-pill border text-dark bg-white selectable-tag m-1 p-2"
                                      data-tag-id="{{ tag.id }}" style="cursor:pointer;">{{ tag.name }}</span>
                            {% endfor %}
                        </div>
                        <div id="tagHiddenInputs" style="display:none;"></div>
                        <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addTagModal">
                            <i class="bi bi-plus-circle me-1"></i> New Tag
                        </button>
                    </div>

                    <div>
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <label class="section-label mb-0">Keywords</label>
                            <a href="/?page=keywords" class="btn btn-manage-mini rounded shadow-sm">
                                <i class="bi bi-key me-1"></i> Manage Keywords
                            </a>
                        </div>
                        <div id="keywordChipContainer" class="chip-box mb-2"></div>
                        <div id="keywordHiddenInputs" style="display:none;"></div>
                        <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addKeywordModal">
                            <i class="bi bi-key me-1"></i> Add Keywords
                        </button>
                    </div>
                </div>
            </div>

            <div class="text-end mt-4 pt-3 border-top">
                <button type="submit" class="btn btn-primary px-5 shadow-sm">Save Biobank</button>
            </div>
        </form>
    </div>
</section>
{% endif %}

{% include "internal/tags/add_tag.html" %}
{% include "internal/keywords/add_keyword.html" %}

</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    console.log(">>> Lógica Híbrida (Sample + Biobank Map) Iniciada");

    /* ===============================================================
       1. MAPA (Específico do Biobank)
    =============================================================== */
    function initSmartLocation() {
        const mapEl = document.getElementById("map");
        // IDs gerados pelo Django
        const institutionInput = document.getElementById("id_institution");
        const latInput = document.getElementById("id_latitude");
        const lngInput = document.getElementById("id_longitude");
        const labelInput = document.getElementById("id_location_label");

        if (!mapEl || typeof L === "undefined") return;

        const map = L.map("map").setView([-15.78, -47.92], 4);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "© OpenStreetMap" }).addTo(map);

        let marker;

        function updateInputs(lat, lng, address) {
            if (latInput) latInput.value = lat.toFixed(6);
            if (lngInput) lngInput.value = lng.toFixed(6);
            if (address && labelInput) {
                labelInput.value = address;
                if (institutionInput && !institutionInput.value) institutionInput.value = address.split(",")[0];
            }
        }

        function reverseGeocode(lat, lng) {
            if(labelInput) labelInput.value = "Searching...";
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                .then(r => r.json())
                .then(data => {
                    if (data.display_name) updateInputs(lat, lng, data.display_name);
                });
        }

        map.on("click", e => {
            const { lat, lng } = e.latlng;
            if (marker) marker.setLatLng([lat, lng]);
            else marker = L.marker([lat, lng], { draggable: true }).addTo(map);
            reverseGeocode(lat, lng);
        });
    }

    /* ===============================================================
       2. TAGS - LÓGICA "SAMPLE" (Via Submit Event)
    =============================================================== */
    function initTagSelector() {
        const tagChips = document.querySelectorAll(".selectable-tag");
        const hiddenContainer = document.getElementById("tagHiddenInputs");

        tagChips.forEach(chip => {
            if (chip.dataset.bound === "1") return;
            chip.dataset.bound = "1";

            chip.addEventListener("click", function() {
                const tagId = this.dataset.tagId;
                // Toggle Visual
                this.classList.toggle("bg-white");
                this.classList.toggle("text-dark");
                this.classList.toggle("bg-primary");
                this.classList.toggle("text-white");

                // Toggle Hidden Input
                const existing = hiddenContainer.querySelector(`input[value="${tagId}"]`);
                if (existing) {
                    existing.remove();
                } else {
                    const input = document.createElement("input");
                    input.type = "hidden";
                    input.name = "tags";
                    input.value = tagId;
                    hiddenContainer.appendChild(input);
                }
            });
        });
    }

    // LÓGICA ANTIGA DO SAMPLE (Intercepta Submit)
    const addTagForm = document.getElementById("addTagForm");
    if (addTagForm) {
        addTagForm.addEventListener("submit", function(e) {
            e.preventDefault(); // Impede o refresh da página
            console.log(">>> Submit interceptado (Estilo Sample)");

            const fd = new FormData(this);
            const csrf = document.querySelector("[name=csrfmiddlewaretoken]")?.value;

            fetch("/ajax/add_tag/", {
                method: "POST",
                body: fd,
                headers: { "X-CSRFToken": csrf }
            })
            .then(r => r.json())
            .then(data => {
                if (!data.success && !data.id) {
                    alert(data.error || "Error");
                    return;
                }

                // Cria o chip visualmente
                const chipContainer = document.getElementById("tagChipContainer");
                const chip = document.createElement("span");
                chip.className = "badge rounded-pill border selectable-tag bg-primary text-white border-primary m-1 p-2";
                chip.dataset.tagId = data.id;
                chip.innerText = data.name;
                chip.style.cursor = "pointer";
                chipContainer.appendChild(chip);

                // Cria o input hidden para salvar
                const hiddenContainer = document.getElementById("tagHiddenInputs");
                const hidden = document.createElement("input");
                hidden.type = "hidden";
                hidden.name = "tags";
                hidden.value = data.id;
                hiddenContainer.appendChild(hidden);

                // Re-bind click events e fecha modal
                initTagSelector();

                // Fecha modal (Bootstrap 5)
                const modalEl = document.getElementById("addTagModal");
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) modal.hide();
                else new bootstrap.Modal(modalEl).hide();

                this.reset();
            })
            .catch(err => console.error(err));
        });
    }

    /* ===============================================================
       3. KEYWORDS - LÓGICA "SAMPLE"
    =============================================================== */
    const addKeywordForm = document.getElementById("addKeywordForm");
    if (addKeywordForm) {
        addKeywordForm.addEventListener("submit", function(e) {
            e.preventDefault();

            // Pega pelos names ou IDs
            const key = (document.getElementById("kw_key") || this.querySelector("[name=key]")).value.trim();
            const val = (document.getElementById("kw_value") || this.querySelector("[name=value]")).value.trim();

            if (!key || !val) {
                alert("Both fields required");
                return;
            }

            const container = document.getElementById("keywordChipContainer");
            const hiddenContainer = document.getElementById("keywordHiddenInputs");

            // Chip Visual
            const chip = document.createElement("span");
            chip.className = "badge bg-light text-dark border p-2 m-1";
            chip.innerHTML = `${key}: ${val} <i class="bi bi-x text-danger ms-2" style="cursor:pointer"></i>`;

            // Input Oculto
            const pair = `${key}:::${val}`;
            const hidden = document.createElement("input");
            hidden.type = "hidden";
            hidden.name = "keyword_pairs";
            hidden.value = pair;

            // Remove logic
            chip.querySelector("i").onclick = () => {
                chip.remove();
                hidden.remove();
            };

            container.appendChild(chip);
            hiddenContainer.appendChild(hidden);

            // Fecha Modal
            const modalEl = document.getElementById("addKeywordModal");
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();
            else new bootstrap.Modal(modalEl).hide();

            this.reset();
        });
    }

    // Inicializa tudo
    initSmartLocation();
    initTagSelector();
});
</script>
{% endblock %}
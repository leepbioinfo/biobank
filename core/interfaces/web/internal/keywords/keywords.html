{% extends "internal/common/base.html" %}
{% load static %}

{% block title %}Manage Keywords Â· Biobank LIMS{% endblock %}
{% block page_title %}Keywords{% endblock %}
{% block page_subtitle %}
View, edit and delete keywords and their values
{% endblock %}

{% block content %}

<h2 class="mb-2">Manage Keywords</h2>
<p class="section-subtitle mb-4">
    View, edit and delete keywords and their values.
</p>

<!-- ===================== LISTA DE CARDS ===================== -->

<div class="keyword-container">

    {% for item in keywords %}
    <div class="keyword-card">

        <div class="keyword-header">
            <h4>{{ item.keyword.name }}</h4>

            <div class="keyword-actions">
                <button class="btn btn-sm btn-outline-primary"
                        onclick="openEditKeyword('{{ item.keyword.id }}','{{ item.keyword.name|escapejs }}')">
                     Edit
                </button>

                <button class="btn btn-sm btn-outline-danger"
                        onclick="openDeleteKeyword('{{ item.keyword.id }}','{{ item.keyword.name|escapejs }}',{{ item.total }})">
                     Delete
                </button>
            </div>
        </div>

        <div class="keyword-values">
            {% for v in item.values %}
                <span class="chip">{{ v.value }}</span>
            {% empty %}
                <span class="empty-text">No values</span>
            {% endfor %}
        </div>

        <div class="keyword-usage">
            <div><strong>{{ item.sample_count }}</strong> samples</div>
            <div><strong>{{ item.collection_count }}</strong> collections</div>
            <div><strong>{{ item.biobank_count }}</strong> biobanks</div>
        </div>

    </div>
    {% empty %}
        <p class="text-muted">No keywords found.</p>
    {% endfor %}

</div>

<!-- ===================== MODAL EDIT ===================== -->

<div id="editModal" class="modal-bg" style="display:none;">
    <div class="modal-card">
        <h3>Edit Keyword</h3>

        <form method="post" action="/?page=edit_keyword">
            {% csrf_token %}
            <input type="hidden" name="id" id="editKeywordId">

            <label>Name</label>
            <input type="text"
                   name="name"
                   id="editKeywordName"
                   class="form-control"
                   required>

            <div class="modal-footer">
                <button class="btn btn-primary">Save</button>
                <button type="button"
                        class="btn btn-secondary"
                        onclick="closeEditModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- ===================== MODAL DELETE ===================== -->

<div id="deleteModal" class="modal-bg" style="display:none;">
    <div class="modal-card">
        <h3>Delete Keyword</h3>
        <p id="deleteMessage"></p>

        <form method="post" action="/?page=delete_keyword">
            {% csrf_token %}
            <input type="hidden" name="id" id="deleteKeywordId">

            <div class="modal-footer">
                <button id="deleteConfirmBtn" class="btn btn-danger">
                    Delete
                </button>
                <button type="button"
                        class="btn btn-secondary"
                        onclick="closeDeleteModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
.keyword-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(330px, 1fr));
    gap: 18px;
}

.keyword-card {
    background: #fff;
    border-radius: 10px;
    padding: 18px;
    border: 1px solid #e5e5e5;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    transition: 0.2s;
}
.keyword-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.12);
}

.keyword-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.keyword-header h4 {
    margin: 0;
    font-size: 18px;
}

.keyword-values {
    margin-top: 12px;
    margin-bottom: 10px;
}
.chip {
    display: inline-block;
    padding: 4px 10px;
    background: #e7efff;
    border-radius: 12px;
    margin: 2px;
    font-size: 13px;
}
.empty-text {
    font-size: 13px;
    color: #777;
}

.keyword-usage {
    border-top: 1px solid #eee;
    padding-top: 10px;
    font-size: 14px;
    display: flex;
    justify-content: space-between;
}

.modal-bg {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}
.modal-card {
    background: white;
    padding: 20px;
    width: 350px;
    border-radius: 8px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.25);
}
.modal-footer {
    display: flex;
    justify-content: flex-end;
    margin-top: 15px;
    gap: 10px;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
const IS_ADMIN = {{ is_admin|yesno:"true,false" }};

function openEditKeyword(id, name) {
    document.getElementById("editKeywordId").value = id;
    document.getElementById("editKeywordName").value = name;
    document.getElementById("editModal").style.display = "flex";
}

function closeEditModal() {
    document.getElementById("editModal").style.display = "none";
}

function openDeleteKeyword(id, name, total) {
    document.getElementById("deleteKeywordId").value = id;

    const msg = document.getElementById("deleteMessage");
    const btn = document.getElementById("deleteConfirmBtn");

    if (total > 0 && !IS_ADMIN) {
        msg.innerHTML =
            `Keyword "<b>${name}</b>" has <b>${total}</b> values and cannot be deleted.`;
        btn.disabled = true;
    } else {
        msg.innerHTML = `Delete keyword "<b>${name}</b>"?`;
        btn.disabled = false;
    }

    document.getElementById("deleteModal").style.display = "flex";
}

function closeDeleteModal() {
    document.getElementById("deleteModal").style.display = "none";
}
</script>
{% endblock %}

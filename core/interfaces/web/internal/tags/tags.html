{% extends "internal/common/base.html" %}
{% load static %}

{% block title %}Manage Tags Â· Biobank LIMS{% endblock %}

{% block page_title %}Tags{% endblock %}
{% block page_subtitle %}
Edit, delete and inspect where each tag is being used
{% endblock %}

{% block content %}

<h2>Manage Tags</h2>
<p class="section-subtitle">
    Edit, delete and inspect where each tag is being used (Biobanks, Collections, Samples).
</p>

<!-- Search -->
<input id="tag-search"
       type="text"
       class="form-control"
       placeholder="Search tags..."
       style="max-width:300px; margin-bottom:20px;">

<div class="card">
    <table class="table">
        <thead>
            <tr>
                <th>Tag</th>
                <th>Used In</th>
                <th style="width:180px;">Actions</th>
            </tr>
        </thead>

        <tbody id="tags-table-body">
            {% for item in tags %}
            <tr class="tag-row" data-name="{{ item.tag.name|lower }}">

                <td>
                    <strong>{{ item.tag.name }}</strong>

                    <div style="margin-top:5px; font-size:13px; color:#444;">

                        {% if item.biobanks %}
                            <div><b>Biobanks:</b>
                                {% for b in item.biobanks %}
                                    <a href="/?page=biobanks&highlight={{ b.id }}">
                                        {{ b.name }}
                                    </a>{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}

                        {% if item.collections %}
                            <div><b>Collections:</b>
                                {% for c in item.collections %}
                                    <a href="/?page=collections&highlight={{ c.id }}">
                                        {{ c.name }}
                                    </a>{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}

                        {% if item.samples %}
                            <div><b>Samples:</b>
                                {% for s in item.samples %}
                                    <a href="/?page=samples&highlight={{ s.id }}">
                                        {{ s.sample_id }}
                                    </a>{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}

                    </div>
                </td>

                <td>
                    {{ item.biobank_count }} biobank(s)<br>
                    {{ item.collection_count }} collection(s)<br>
                    {{ item.sample_count }} sample(s)
                </td>

                <td>
                    <button type="button"
                            class="btn btn-sm btn-outline-primary"
                            onclick="openEditModal('{{ item.tag.id }}', '{{ item.tag.name|escapejs }}')">
                        Edit
                    </button>

                    <button type="button"
                            class="btn btn-sm btn-outline-danger"
                            onclick="openDeleteModal('{{ item.tag.id }}', '{{ item.tag.name|escapejs }}', {{ item.total_use }})">
                        Delete
                    </button>
                </td>

            </tr>
            {% empty %}
            <tr>
                <td colspan="3">No tags found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- ================= MODALS ================= -->

<div id="editModal" class="modal-bg" style="display:none;">
    <div class="modal-card">
        <h3>Edit Tag</h3>

        <form method="post" action="/?page=edit_tag">
            {% csrf_token %}
            <input type="hidden" name="id" id="editTagId">

            <label>Name</label>
            <input type="text"
                   name="name"
                   id="editTagName"
                   class="form-control"
                   required>

            <div style="margin-top:10px;">
                <button class="btn btn-primary">Save</button>
                <button type="button"
                        class="btn btn-secondary"
                        onclick="closeEditModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div id="deleteModal" class="modal-bg" style="display:none;">
    <div class="modal-card">
        <h3>Delete Tag</h3>
        <p id="deleteMessage"></p>

        <form method="post" action="/?page=delete_tag">
            {% csrf_token %}
            <input type="hidden" name="id" id="deleteTagId">

            <button id="deleteConfirmBtn" class="btn btn-danger">Delete</button>
            <button type="button"
                    class="btn btn-secondary"
                    onclick="closeDeleteModal()">Cancel</button>
        </form>
    </div>
</div>

<!-- ================= JS ================= -->

<script>
const IS_ADMIN = {{ is_admin|yesno:"true,false" }};

function openEditModal(id, name) {
    document.getElementById("editTagId").value = id;
    document.getElementById("editTagName").value = name;
    document.getElementById("editModal").style.display = "flex";
}

function closeEditModal() {
    document.getElementById("editModal").style.display = "none";
}

function openDeleteModal(id, name, totalUse) {
    const msg = document.getElementById("deleteMessage");
    const btn = document.getElementById("deleteConfirmBtn");
    document.getElementById("deleteTagId").value = id;

    if (totalUse > 0 && !IS_ADMIN) {
        msg.innerHTML =
            `Tag "<b>${name}</b>" is used in <b>${totalUse}</b> entities and cannot be deleted.`;
        btn.disabled = true;
    } else {
        msg.innerHTML =
            `Are you sure you want to delete "<b>${name}</b>"?`;
        btn.disabled = false;
    }

    document.getElementById("deleteModal").style.display = "flex";
}

function closeDeleteModal() {
    document.getElementById("deleteModal").style.display = "none";
}

document.getElementById("tag-search").addEventListener("input", function() {
    const q = this.value.toLowerCase();
    document.querySelectorAll(".tag-row").forEach(row => {
        row.style.display = row.dataset.name.includes(q) ? "" : "none";
    });
});
</script>

{% endblock %}

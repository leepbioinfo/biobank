{% extends "internal/common/base.html" %}
{% load static %}

{% block title %}Biobanks · Biobank LIMS{% endblock %}
{% block page_title %}Biobanks{% endblock %}
{% block page_subtitle %}Manage biobanks and their collections{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'internal/biobanks/biobank.css' %}">
<link rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
{% endblock %}

{% block content %}

<div class="biobank-page">

{% if user.is_authenticated %}
<section class="card biobank-card">
    <h3 class="card-title">Create Biobank</h3>

    <form method="post" class="biobank-form">
        {% csrf_token %}
        <input type="hidden" name="action" value="add_biobank">

        <!-- BASIC INFO -->
        <div class="form-grid">
            <div class="form-group">
                {{ biobank_form.name.label_tag }}
                {{ biobank_form.name }}
            </div>

            <div class="form-group">
                {{ biobank_form.visibility.label_tag }}
                {{ biobank_form.visibility }}
            </div>
        </div>

        <div class="form-group mt-3">
            {{ biobank_form.institution.label_tag }}
            {{ biobank_form.institution }}
            <small class="text-muted">
                Search institution or address (city, hospital, research center)
            </small>
        </div>

        <!-- LOCATION + NOTES -->
        {{ biobank_form.location_label }}
        {{ biobank_form.latitude }}
        {{ biobank_form.longitude }}

        <div class="row mt-4">

            <!-- NOTES -->
            <div class="col-md-7">
                <label class="section-label">Notes</label>
                {{ biobank_form.notes }}
            </div>

            <!-- MAP -->
            <div class="col-md-5">
                <label class="section-label">Location</label>
                <div id="map" style="height:220px; border-radius:10px;"></div>
                <small class="text-muted">
                    Location updates automatically while typing
                </small>
            </div>

        </div>

        <!-- TAGS -->
        <div class="form-group mt-4">
            <label class="section-label">Tags</label>

            <div id="tagChipContainer" class="chip-box mb-2">
                {% for tag in all_tags %}
                    <span class="tag-chip selectable-tag"
                          data-tag-id="{{ tag.id }}">
                        {{ tag.name }}
                    </span>
                {% empty %}
                    <span class="text-muted">No tags available</span>
                {% endfor %}
            </div>

            <div id="tagHiddenInputs" style="display:none;"></div>

            <div class="d-flex gap-2">
                <button type="button"
                        class="btn btn-outline-secondary btn-sm"
                        data-bs-toggle="modal"
                        data-bs-target="#addTagModal">
                    + Add Tag
                </button>

                <a href="/?page=tags"
                   class="btn btn-outline-secondary btn-sm">
                    Manage Tags
                </a>
            </div>
        </div>

        <!-- KEYWORDS -->
        <div class="form-group mt-4">
            <label class="section-label">Keywords</label>

            <div id="keywordChipContainer" class="chip-box mb-2"></div>
            <div id="keywordHiddenInputs" style="display:none;"></div>

            <div class="d-flex gap-2">
                <button type="button"
                        class="btn btn-outline-secondary btn-sm"
                        data-bs-toggle="modal"
                        data-bs-target="#addKeywordModal">
                    + Add Keyword
                </button>

                <a href="/?page=keywords"
                   class="btn btn-outline-secondary btn-sm">
                    Manage Keywords
                </a>
            </div>
        </div>

        <div class="form-actions mt-4">
            <button class="btn btn-primary">
                Save Biobank
            </button>
        </div>

    </form>
</section>
{% endif %}

<!-- ======================================================
   BIOBANK LIST
====================================================== -->
<section class="biobank-list mt-5">
    <h3 class="section-title">Registered Biobanks</h3>

    {% if biobanks %}
    <div class="biobank-grid">

        {% for b in biobanks %}
        <div class="card biobank-entry">

            <h4>{{ b.name }}</h4>

            <p class="mb-1">
                <strong>Visibility:</strong>
                {{ b.get_visibility_display }}
            </p>

            {% if b.location_label %}
                <p class="text-muted small">
                    {{ b.location_label }}
                </p>
            {% endif %}

            <!-- TAGS -->
            <div class="meta-block">
                {% for t in b.tags.all %}
                    <span class="tag-pill">{{ t.name }}</span>
                {% endfor %}
            </div>

            <!-- KEYWORDS -->
            <div class="meta-block">
                {% for k in b.keywords.all %}
                    <span class="kw-pill">
                        {{ k.keyword.name }} → {{ k.value }}
                    </span>
                {% endfor %}
            </div>

            <!-- ACTIONS -->
            <div class="biobank-actions mt-3">

                {% if b.can_manage_members %}
                <a href="/biobanks/{{ b.id }}/members/"
                   class="btn btn-outline-secondary btn-sm w-100 mb-2">
                    Manage Members
                </a>
                {% endif %}

                {% if b.can_edit %}
                <form method="post" class="mb-2">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="deactivate_biobank">
                    <input type="hidden" name="id" value="{{ b.id }}">
                    <button class="btn btn-outline-warning btn-sm w-100">
                        Deactivate
                    </button>
                </form>
                {% endif %}

                {% if user.is_superuser %}
                <button type="button"
                        class="btn btn-outline-danger btn-sm w-100 js-delete-biobank"
                        data-biobank-id="{{ b.id }}"
                        data-biobank-name="{{ b.name }}">
                    Delete
                </button>
                {% endif %}

            </div>

        </div>
        {% endfor %}

    </div>
    {% else %}
        <p class="text-muted">No biobanks available.</p>
    {% endif %}
</section>

<!-- ======================================================
   DELETE BIOBANK CONFIRM MODAL
====================================================== -->
<div class="modal fade" id="confirmDeleteBiobankModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">
          ⚠️ Delete Biobank
        </h5>
        <button class="btn-close btn-close-white"
                data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p>
          You are about to <strong>permanently delete</strong>
          the biobank:
        </p>

        <p class="fw-bold text-danger" id="deleteBiobankName"></p>

        <ul class="mt-3">
          <li> All collections</li>
          <li> All samples and files</li>
          <li> All metadata</li>
        </ul>

        <p class="text-muted mt-3">
          If you only want to disable access,
          consider <strong>deactivating</strong> the biobank instead.
        </p>

        <p class="fw-bold">
          Are you sure you want to continue?
        </p>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary"
                data-bs-dismiss="modal">
          Cancel
        </button>

        <form method="post" id="confirmDeleteBiobankForm">
          {% csrf_token %}
          <input type="hidden" name="action" value="delete_biobank">
          <input type="hidden" name="id" id="deleteBiobankId">
          <button class="btn btn-danger">
            Yes, delete permanently
          </button>
        </form>
      </div>

    </div>
  </div>
</div>

{% include "internal/tags/add_tag.html" %}
{% include "internal/keywords/add_keyword.html" %}

</div>

{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="{% static 'internal/biobanks/biobank.js' %}"></script>
{% endblock %}
